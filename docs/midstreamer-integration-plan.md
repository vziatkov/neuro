# Начальный План Midstreamer-integration

## 1. Цели интеграции

### 1.1. Краткосрочные цели
- Реал-тайм детекция аномалий поведения в HTML5-играх (Pixi/Svelte)
- Адаптивная сложность в обучающих играх на основе паттернов взаимодействия
- Базовый эмоциональный детектор для Fantaziya через temporal-сигналы
- CLI-прототип для валидации концепции

### 1.2. Долгосрочные цели
- "Память мира" для Fantaziya: хранение и поиск похожих паттернов жизни существ через AgentDB
- Независимый слой безопасности для ассистентов (prompt injection detection)
- Индивидуальный репетитор, подстраивающийся под реальные паттерны ребёнка
- Эмоциональный стабилизатор, следящий за качеством взаимодействия с ИИ

### 1.3. KPI
**Технические:**
- Латентность детекции аномалий < 100ms
- Точность классификации состояний > 85%
- Покрытие edge-кейсов > 90%

**UX:**
- Снижение фрустрации игроков на 30% (метрика: время до ухода)
- Увеличение engagement в обучающих играх на 25%
- Улучшение качества взаимодействия с Fantaziya (субъективная оценка)

**Обучающие:**
- Адаптация сложности под ребёнка в реальном времени
- Выявление паттернов "понял / буксует" с точностью > 80%

---

## 2. Сценарии использования (Use Cases)

### 2.1. Игровая аналитика (HTML5/Pixi/Svelte)
**Проблема:** Нужно понимать состояние игрока (tilt, выгорание, скука) без явных метрик.

**Решение:**
- Собирать телеметрию: скорость кликов, интервалы, win/loss streak, длина сессии
- Преобразовывать в временные последовательности
- Пропускать через Midstreamer с baseline "нормального поведения"
- При `Similarity < threshold` → аномалия → сигнал обратно в игру: `STATE: "overwhelmed" | "bored" | "focus" | "rage"`

**Интеграция:**
- WebSocket/HTTP endpoint для приёма телеметрии
- Node-скрипт с `npx midstreamer stream --window N --reference baseline`
- Push событий обратно в игру для динамической сложности

### 2.2. Адаптивное обучение ребёнка
**Проблема:** Статическая сложность не учитывает реальное состояние ребёнка.

**Решение:**
- Трекать: время ответа, количество ошибок подряд, использование подсказок, темп прохождения
- Baseline: "комфортный темп обучения"
- DTW-отклонения:
  - Слишком быстро → усложняем
  - Слишком медленно → подсказки, упрощаем, меняем формат

**Интеграция:**
- Temporal-секвенции из игровых событий
- CLI-прототип: `seq 1 100 | npx midstreamer stream --window 20`
- JSON-вывод → "скоринг фрустрации" → адаптация UI

### 2.3. Fantaziya: память + эмоциональные сигналы
**Проблема:** Нужен эмоциональный детектор без прямого доступа к LLM.

**Решение:**
- Собирать поведенческие сигналы: скорость ввода, частота обращений, длительность сессий, интенсивность взаимодействия
- Temporal-секвенции: `[запросов в минуту]`, `[средняя длина сообщений]`, `[время до следующего сообщения]`
- Baseline: "спокойное, здоровое использование"
- При drift → состояние "distress / overuse / паника"

**Интеграция:**
- Слой между UI и LLM
- Разные baseline'ы: игровое состояние, учёба, залипание
- AgentDB для хранения паттернов использования

### 2.4. Безопасность ассистентов (prompt-injection)
**Проблема:** Нужен независимый от LLM слой безопасности.

**Решение:**
- Midstreamer + AgentDB как детектор аномалий в input
- Обучить на: SQL injection, XSS, jailbreak prompts, кастомные запрещённые сценарии
- Temporal-паттерны в цепочках сообщений

**Интеграция:**
- Промежуточный слой перед отправкой в LLM
- Валидация на уровне последовательностей, а не только токенов

---

## 3. Техническая архитектура

### 3.1. Потоки данных

```
[Игра/UI] → [Телеметрия] → [Midstreamer Stream] → [Anomaly Detection] → [State Signal] → [Игра/UI]
                ↓
         [Baseline Storage]
                ↓
         [AgentDB Memory]
```

**Компоненты:**
- **Collector:** сбор телеметрии (клики, интервалы, события)
- **Streamer:** преобразование в временные последовательности
- **Midstreamer Engine:** анализ через DTW и similarity
- **AgentDB:** хранение паттернов и поиск похожих
- **Signal Generator:** генерация состояний (NORMAL / FAST / SLOW / RAGE / FOCUS / BORED)

### 3.2. Midstreamer Streaming Engine
- **Window size:** настраиваемый (20-100 точек)
- **Reference sequences:** baseline-паттерны для сравнения
- **Output format:** JSON с метриками similarity, drift, anomaly flags

### 3.3. AgentDB Memory Layer
- **Embeddings:** векторные представления временных последовательностей
- **Similarity search:** поиск похожих паттернов по запросу
- **Timeline storage:** хранение истории паттернов для анализа трендов

### 3.4. Точки интеграции с UI/игрой
- **WebSocket endpoint:** приём телеметрии в реальном времени
- **Event emitter:** отправка сигналов обратно в игру
- **Dashboard:** визуализация паттернов и аномалий (опционально)

---

## 4. Baseline-паттерны

### 4.1. Как собираются
- **Ручная запись:** "нормальная" сессия игры/обучения записывается как reference
- **Автоматическая агрегация:** медианные паттерны из успешных сессий
- **Кластеризация:** группировка похожих паттернов для разных состояний

### 4.2. Как хранятся
- **JSON-файлы:** простые reference sequences для CLI-прототипа
- **AgentDB:** векторные embeddings для поиска похожих паттернов
- **Versioning:** отслеживание изменений baseline'ов во времени

### 4.3. Как обновляются
- **Периодический пересчёт:** раз в неделю/месяц на основе новых данных
- **Адаптивные baseline'ы:** постепенное обновление через moving average
- **A/B тестирование:** сравнение эффективности разных baseline'ов

### 4.4. Как валидируются
- **Тестовые сессии:** проверка на известных паттернах (tilt, focus, boredom)
- **Cross-validation:** разделение на train/test для оценки точности
- **Human feedback:** субъективная оценка корректности детекции

---

## 5. Аномалии и триггеры

### 5.1. Порог Similarity
- **NORMAL:** similarity > 0.85
- **WARNING:** similarity 0.70 - 0.85
- **ANOMALY:** similarity < 0.70

### 5.2. Drift-метрика
- **Стабильный:** drift < 0.1
- **Умеренный:** drift 0.1 - 0.3
- **Критический:** drift > 0.3

### 5.3. Типы сигналов
- **NORMAL:** стандартное поведение, baseline соответствует
- **FAST:** ускоренный темп (возможна фрустрация или энтузиазм)
- **SLOW:** замедленный темп (возможна усталость или сложность)
- **RAGE:** резкие скачки, высокая вариативность (tilt)
- **FOCUS:** стабильный, предсказуемый паттерн (глубокое погружение)
- **BORED:** низкая активность, длинные паузы

### 5.4. Действия на каждый сигнал
- **NORMAL:** продолжать текущую сложность
- **FAST:** увеличить сложность или предложить новые вызовы
- **SLOW:** уменьшить сложность, предложить подсказки
- **RAGE:** мягкая интервенция (пауза, подсказка, изменение формата)
- **FOCUS:** поддерживать текущее состояние, не отвлекать
- **BORED:** активировать новые механики, изменить контекст

---

## 6. План реализации (итерации)

### 6.1. Итерация 1 — CLI-прототип
**Цель:** Валидация концепции на простых данных

**Задачи:**
- Установка `midstreamer`: `npm install midstreamer`
- Создание тестовых последовательностей
- Запуск: `seq 1 100 | npx midstreamer stream --window 20 --format json`
- Анализ вывода и настройка порогов

**Результат:** Рабочий CLI, понимание метрик similarity/drift

### 6.2. Итерация 2 — интеграция в тестовую игру
**Цель:** Реал-тайм детекция в простой HTML5-игре

**Задачи:**
- Создание мини-игры (Svelte/Pixi playground)
- Сбор телеметрии: клики, интервалы
- Node-скрипт с Midstreamer для анализа
- WebSocket для двусторонней связи
- Визуализация сигналов в игре

**Результат:** Демо с работающей детекцией аномалий

### 6.3. Итерация 3 — визуализация и графики
**Цель:** Дашборд для понимания паттернов

**Задачи:**
- График временных последовательностей
- Визуализация similarity/drift метрик
- Heatmap аномалий
- История состояний (timeline)

**Результат:** Инструмент для анализа и отладки

### 6.4. Итерация 4 — AgentDB память
**Цель:** Хранение и поиск похожих паттернов

**Задачи:**
- Интеграция AgentDB
- Создание embeddings для последовательностей
- Поиск похожих паттернов по запросу
- Хранение baseline'ов в AgentDB

**Результат:** Система памяти паттернов

### 6.5. Итерация 5 — финальный MVP
**Цель:** Полнофункциональная система для одного use case

**Задачи:**
- Выбор приоритетного use case (игровая аналитика или обучение)
- Полная интеграция всех компонентов
- Тестирование на реальных данных
- Документация и примеры использования

**Результат:** Готовый MVP для продакшена

---

## 7. Риски и ограничения

### 7.1. Производительность
**Риск:** Задержки при обработке больших последовательностей

**Митигация:**
- Оптимизация window size
- Асинхронная обработка
- Кэширование baseline'ов
- Sampling для длинных последовательностей

### 7.2. Достоверность паттернов
**Риск:** Ложные срабатывания или пропуск аномалий

**Митигация:**
- Тщательная валидация baseline'ов
- Калибровка порогов на тестовых данных
- Human feedback loop
- Ensemble методов (несколько baseline'ов)

### 7.3. UX-ограничения
**Риск:** Интервенции могут раздражать пользователя

**Митигация:**
- Мягкие, ненавязчивые подсказки
- A/B тестирование интервенций
- Опциональное отключение адаптации
- Прозрачность для пользователя (почему изменилась сложность)

### 7.4. Edge-кейс ошибки данных
**Риск:** Некорректные данные → неправильные выводы

**Митигация:**
- Валидация входных данных
- Обработка missing values
- Graceful degradation при ошибках
- Логирование для отладки

---

## 8. Следующие шаги

### 8.1. Подготовить baseline
- Записать "нормальные" сессии игры/обучения
- Преобразовать в reference sequences
- Сохранить в JSON/AgentDB

### 8.2. Настроить streaming
- Установить Midstreamer
- Создать Node-скрипт для обработки потока
- Настроить WebSocket endpoint

### 8.3. Собрать первую аналитику
- Запустить на тестовых данных
- Собрать метрики similarity/drift
- Проанализировать корреляцию с реальными состояниями

### 8.4. Сделать визуальный дашборд
- Графики временных последовательностей
- Индикаторы аномалий
- История состояний

---

## Приложение: Быстрый старт

```bash
# 1. Установка
npm install midstreamer

# 2. Тест CLI
npx midstreamer benchmark

# 3. Простой поток
seq 1 100 | npx midstreamer stream --window 20 --format json

# 4. С reference baseline
echo "1,2,3,4,5" > baseline.txt
seq 1 100 | npx midstreamer stream --window 5 --reference baseline.txt
```

---

## Ссылки

- [Midstreamer npm package](https://www.npmjs.com/package/midstreamer)
- [AgentDB documentation](https://agentdb.ai/docs)
- [DTW algorithm explanation](https://en.wikipedia.org/wiki/Dynamic_time_warping)

